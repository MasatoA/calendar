<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Document</title>
    <link rel="stylesheet" href="css/carendar.css" media="screen and (min-width:421px)">
    <link rel="stylesheet" href="css/sp_carendar.css" media="screen and (max-width:420px)">
    
    <script>
        window.addEventListener("DOMContentLoaded",function(){Init();});
        function Init(){
            var mainElement = document.createElement("div");
            mainElement.setAttribute("id","main");
            document.body.appendChild(mainElement);

            var calendarframe = document.createElement("div");
            calendarframe.setAttribute("id","calendar_frame");
            mainElement.appendChild(calendarframe);


            const calendarUrl = "https://holidays-jp.github.io/api/v1/" + new Date().getFullYear()+ "/date.json";
            const tenkiUrl = "https://api.open-meteo.com/v1/forecast?latitude=36.70&longitude=137.21&daily=weathercode&current_weather=true&timezone=Asia%2FTokyo";

            let tenkiData = []; //å¤©æ°—jsonå—ã‘å–ã‚Šç”¨å¤‰æ•°
            
            fetch(tenkiUrl) //1å›ç›®ã®fetchã€å¤©æ°—ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                .then(tenki => tenki.json())
                .then(getTenki => {
                    tenkiData = getTenki.daily;
                    return fetch(calendarUrl);  //2å›ç›®ã®fetch,ç¥æ—¥ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’å–å¾—
                })
                .then(res => res.json())
                .then(json => calendar_load(json,tenkiData))
        }

        //ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»å‡¦ç†
        function calendar_load(holidayJson,tenkiData){
            var nowdate = new Date();
            var nowMonth = nowdate.getMonth() + 1;
            var firstDay = (new Date(nowdate.getFullYear(),nowdate.getMonth(),1)).getDay();
            var weekStr = ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"];           
            const weekEng = ["sun","mon","tue","wed","thu","fri","sat"];
            //æœˆã‚¿ã‚¤ãƒˆãƒ«è¡¨ç¤º
            var monthElement = document.createElement("h2");
            monthElement.setAttribute("class","month_title");
            monthElement.textContent = nowdate.getFullYear() + "å¹´" + nowMonth + "æœˆ";
            document.getElementById("calendar_frame").appendChild(monthElement);

            //ulè¦ç´ ä½œæˆ
            var ulElement = document.createElement("ul");
            ulElement.setAttribute("class","calendar");
            document.getElementById("calendar_frame").appendChild(ulElement);

            //æ›œæ—¥è¡Œä½œæˆ
            for(i = 0;i < 7;i++){
                var calendarHeader = document.createElement("li");
                calendarHeader.setAttribute("class","header");
                calendarHeader.textContent = weekStr[i];
                ulElement.appendChild(calendarHeader);
            }
            
            //å…ˆæœˆåˆ†ã®æœ€çµ‚æ—¥ãŒå‡ºã‚‹ã®ã§æ³¨æ„ã€‚è¡¨ç¤ºæœˆã¯+1ã—ã¦ã‚‹ã®ã§ã¡ã‚‡ã†ã©è‰¯ã„
            const getLastDay = (year, month) => {
                return new Date(year, month, 0).getDate();
            };

            const generateWeatherIcon = weatherCode => {
                    // https://www.jodc.go.jp/data_format/weather-code_j.html
                    const iconText = (() => {
                        if(weatherCode === 0) return { text: 'å¿«æ™´'  , emoji: 'â˜€' };  // 0 : Clear Sky
                        if(weatherCode === 1) return { text: 'æ™´ã‚Œ'  , emoji: 'ğŸŒ¤' };  // 1 : Mainly Clear
                        if(weatherCode === 2) return { text: 'ä¸€éƒ¨æ›‡', emoji: 'â›…' };  // 2 : Partly Cloudy
                        if(weatherCode === 3) return { text: 'æ›‡ã‚Š'  , emoji: 'â˜' };  // 3 : Overcast
                        if(weatherCode <= 49) return { text: 'éœ§'    , emoji: 'ğŸŒ«' };  // 45, 48 : Fog And Depositing Rime Fog
                        if(weatherCode <= 59) return { text: 'éœ§é›¨'  , emoji: 'ğŸŒ§' };  // 51, 53, 55 : Drizzle Light, Moderate And Dense Intensity ãƒ» 56, 57 : Freezing Drizzle Light And Dense Intensity
                        if(weatherCode <= 69) return { text: 'é›¨'    , emoji: 'â˜”' };  // 61, 63, 65 : Rain Slight, Moderate And Heavy Intensity ãƒ»66, 67 : Freezing Rain Light And Heavy Intensity
                        if(weatherCode <= 79) return { text: 'é›ª'    , emoji: 'â˜ƒ' };  // 71, 73, 75 : Snow Fall Slight, Moderate And Heavy Intensity ãƒ» 77 : Snow Grains
                        if(weatherCode <= 84) return { text: 'ä¿„ã‹é›¨', emoji: 'ğŸŒ§' };  // 80, 81, 82 : Rain Showers Slight, Moderate And Violent
                        if(weatherCode <= 94) return { text: 'é›ªãƒ»é›¹', emoji: 'â˜ƒ' };  // 85, 86 : Snow Showers Slight And Heavy
                        if(weatherCode <= 99) return { text: 'é›·é›¨'  , emoji: 'â›ˆ' };  // 95 : Thunderstorm Slight Or Moderate ãƒ» 96, 99 : Thunderstorm With Slight And Heavy Hail
                        return                       { text: 'ä¸æ˜'  , emoji: 'âœ¨' };
                    })();
                 return iconText.emoji;
            };


            //æ—¥ä»˜ãƒã‚¹ä½œæˆ
            const dayMax = Math.ceil((firstDay + getLastDay(nowdate.getFullYear(),nowMonth)) / 7) * 7;
            for(i = 0;i < dayMax; i++){
                var calendarChild = document.createElement("li");
                calendarChild.setAttribute("class","calendar_child");
                //æ›œæ—¥ã‚¯ãƒ©ã‚¹ã‚»ãƒƒãƒˆ
                var youbi = i % 7;  //iÃ·ï¼—ã®ã‚ã¾ã‚Šã‹ã‚‰æ›œæ—¥ã‚’æ±‚ã‚ã‚‹
                calendarChild.setAttribute("class",weekEng[youbi]);

                ulElement.appendChild(calendarChild);


                var calendarText = document.createElement("h3");
                calendarChild.appendChild(calendarText);
                //1æ—¥ã®æ›œæ—¥ã«ãªã£ã¦ã‹ã‚‰å‡¦ç†
                if(i >= firstDay && (firstDay + getLastDay(nowdate.getFullYear(),nowMonth)) > i){                   
                    var hiduke = nowdate.getFullYear() + "-" + ("0" + (nowdate.getMonth()+1)).slice(-2) + "-" + ("0" +(i + 1 - firstDay)).slice(-2);

                    if(((new Date(hiduke)).getMonth() + 1 ) == nowMonth){
                        //æ—¥ä»˜ã‚’å…¥ã‚Œã‚‹
                        calendarText.textContent = i + 1 - firstDay;

                        //å¤©æ°—è¡¨ç¤ºå‡¦ç†

                        //é…åˆ—å†…ã«æ—¥ä»˜ãŒã‚ã£ãŸå ´åˆ
                        //findã¯ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’å¼•æ•°ã«æŒã¡ã€booleanã§åˆ¤åˆ¥ã™ã‚‹
                        const hidukeIndex = tenkiData.time.findIndex(date => hiduke == date);
                        if(hidukeIndex > -1){
                            var tenkiText = document.createElement("p");
                            tenkiText.setAttribute("class","tenki");
                            tenkiText.textContent = generateWeatherIcon(tenkiData.weathercode[hidukeIndex]);
                            calendarChild.appendChild(tenkiText);
                        }

                        //ç¥æ—¥æ¤œç´¢
                        if(holidayJson[hiduke]){
                            //cssã§ã¯ã‚¿ã‚°ã‚»ãƒ¬ã‚¯ã‚¿ã¨ä½µç”¨ã§åŒºåˆ¥ã™ã‚‹
                            var holidayText = document.createElement("p");
                            holidayText.setAttribute("class","holiday");
                            holidayText.textContent = holidayJson[hiduke];
                            calendarChild.appendChild(holidayText);

                            calendarText.setAttribute("class","holiday");
                        }

                    }
                } else{
                    //æœˆã«å«ã¾ã‚Œãªã„éƒ¨åˆ†ã¯ã¨ã‚Šã‚ãˆãšã‚¯ãƒ©ã‚¹noneã§åŒºåˆ¥ã—ã¦ãŠã
                    calendarChild.setAttribute("class","none");
                }

            }
        }

        
    </script>
</head>
<body>
    

</body>
</html>